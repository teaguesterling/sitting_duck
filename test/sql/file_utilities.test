# name: test/sql/file_utilities.test
# description: Test file utility macros for extracting source code from files
# group: [sql]

require sitting_duck

statement ok
LOAD sitting_duck;

# =============================================================================
# ast_get_source - Extract source lines as a single string
# =============================================================================

# Get single line as text
query I
SELECT ast_get_source('test/data/python/simple.py', 1, 1);
----
def hello():

# Get multiple lines - contains newlines
query I
SELECT ast_get_source('test/data/python/simple.py', 1, 2) LIKE '%def hello()%Say hello%';
----
true

# =============================================================================
# ast_get_source_numbered - Extract source with line numbers
# =============================================================================

# Returns source with line numbers prefixed
query I
SELECT ast_get_source_numbered('test/data/python/simple.py', 1, 1) LIKE '%1:%def hello()%';
----
true

# =============================================================================
# ast_get_source_line - Get a single line
# =============================================================================

# Get first line
query I
SELECT ast_get_source_line('test/data/python/simple.py', 1);
----
def hello():

# Get line from middle
query I
SELECT ast_get_source_line('test/data/python/simple.py', 5);
----
class MyClass:

# =============================================================================
# Integration with read_ast
# =============================================================================

# Note: read_text (which underlies these macros) doesn't support lateral joins,
# so we can't use ast_get_source(file_path, start_line, end_line) directly
# with read_ast results. Instead, use the line numbers to call the function
# with a literal file path.

# Get line range for a function definition
query I
SELECT start_line FROM read_ast('test/data/python/simple.py')
WHERE type = 'function_definition' AND name = 'hello';
----
1

# Then use that info to extract source (with literal path)
query I
SELECT ast_get_source('test/data/python/simple.py', 1, 3) LIKE 'def hello()%';
----
true
