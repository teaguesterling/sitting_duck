# name: test/sql/languages/bash_language_support.test
# description: Test Bash language support functionality
# group: [languages]

require sitting_duck

# Test 1: Bash language is supported
# ==================================

query I
SELECT language FROM ast_supported_languages() WHERE language = 'bash';
----
bash

# Test 2: Bash file extension auto-detection
# ==========================================

query I
SELECT COUNT(*) > 0 FROM read_ast('test/data/bash/simple.sh');
----
true

# Test 3: Explicit Bash language specification
# =============================================

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash') WHERE name IS NOT NULL;
----
1472

# Test 4: Bash function definitions
# =================================

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type = 'function_definition';
----
5

# Test 5: Bash variable assignments
# =================================

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type = 'variable_assignment';
----
28

# Test 6: Bash command substitutions
# ==================================

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type = 'command_substitution';
----
10

# Test 7: Bash control structures
# ===============================

query III
SELECT type, COUNT(*) as count, semantic_type
FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type IN ('if_statement', 'for_statement', 'while_statement', 'case_statement')
GROUP BY type, semantic_type
ORDER BY type;
----
case_statement	2	FLOW_CONDITIONAL
for_statement	3	FLOW_LOOP
if_statement	13	FLOW_CONDITIONAL
while_statement	2	FLOW_LOOP

# Test 8: Bash semantic types for key constructs
# ==============================================

query ITI
SELECT type, semantic_type, COUNT(*) as count
FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type IN ('function_definition', 'variable_assignment', 'command_substitution')
GROUP BY type, semantic_type
ORDER BY type;
----
command_substitution	COMPUTATION_CALL	10
function_definition	DEFINITION_FUNCTION	5
variable_assignment	DEFINITION_VARIABLE	28

# Test 9: Bash tree structure validation
# ======================================

query II
SELECT MAX(depth) as max_depth, COUNT(*) as total_nodes
FROM read_ast('test/data/bash/simple.sh', 'bash');
----
17	1472

# Test 10: Bash word identifiers
# ==============================

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type = 'word' AND name IS NOT NULL;
----
153

# Test 11: Bash string literals
# =============================

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type IN ('string', 'raw_string', 'ansi_c_string');
----
90

# Test 12: Bash pipeline operations
# =================================

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type = 'pipeline';
----
5

# Test 13: Bash array operations
# ==============================

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type IN ('array', 'subscript');
----
14

# Test 14: Function definition name extraction
# =============================================
# Verifies that all 5 function names are correctly extracted

query IT
SELECT name, type FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type = 'function_definition'
ORDER BY start_line;
----
show_usage	function_definition
process_file	function_definition
run_system_checks	function_definition
analyze_files	function_definition
main	function_definition

# Test 15: Variable assignment name extraction
# =============================================
# Verifies that variable_assignment nodes have their variable names extracted

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type = 'variable_assignment' AND name != '';
----
27

# Test 16: Declaration command name extraction
# =============================================
# Verifies that declare/local/readonly commands extract the variable name,
# handling both nested variable_assignment and bare declarations with flags

query IT
SELECT name, type FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type = 'declaration_command'
ORDER BY start_line;
----
FILES_PROCESSED	declaration_command
CONFIG_MAP	declaration_command
file_path	declaration_command
backup_dir	declaration_command
counter	declaration_command
file_size	declaration_command
line_count	declaration_command
filename	declaration_command
extension	declaration_command
basename	declaration_command
system_ok	declaration_command
git_version	declaration_command
disk_usage	declaration_command
pattern	declaration_command
files	declaration_command
verbose	declaration_command
config_file	declaration_command
input_files	declaration_command

# Test 17: Redirect semantic types
# =================================
# Redirects should be EXECUTION_STATEMENT, not EXTERNAL_IMPORT

query IT
SELECT DISTINCT semantic_type, type FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE type IN ('file_redirect', 'heredoc_redirect')
ORDER BY type;
----
EXECUTION_STATEMENT	file_redirect
EXECUTION_STATEMENT	heredoc_redirect

# Test 18: Minimal empty names for definition nodes
# ==================================================
# Nearly all definition nodes should have names extracted.
# The one remaining case is `counter=$((counter + 1))` where the
# variable_assignment contains an arithmetic expansion without a
# variable_name child node.

query I
SELECT COUNT(*) FROM read_ast('test/data/bash/simple.sh', 'bash')
WHERE semantic_type LIKE 'DEFINITION%' AND type NOT IN ('program') AND name = '';
----
1